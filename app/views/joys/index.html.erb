<%= turbo_stream_from "joys" %>

<div class="container" style="display:flex; gap: 1rem; align-items: stretch; height: 100vh;">
  <div id="map" data-controller="map" data-map-joys-url-value="/joys.json" style="flex: 1; height: 100vh; background: #f6f7f9; border-radius: 12px; overflow: hidden; position: relative;">
    <button data-action="click->map#surprise" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      üé≤ Surpresa
    </button>
  </div>

  <div style="flex: 1; min-width: 360px; max-height: 100vh; overflow: auto;">
    <h2 style="margin: 0 0 .5rem 0;">Pequenas Alegrias</h2>

    <%= form_with model: @joy, url: joys_path, data: { turbo: true }, style: "margin-bottom: 1rem; display:grid; gap:.5rem;" do |f| %>
      <div>
        <%= f.label :emoji, "Emoji" %>
        <%= f.text_field :emoji, required: true, placeholder: "üòä", maxlength: 4 %>
      </div>
      <div>
        <%= f.label :body, "Sua alegria" %>
        <%= f.text_area :body, required: true, maxlength: 140, placeholder: "Caf√© perfeito, p√¥r do sol bonito, elogio inesperado..." %>
      </div>
      <div style="display:flex; gap:.5rem; align-items: center;">
        <%= f.hidden_field :lat, id: "joy_lat" %>
        <%= f.hidden_field :lng, id: "joy_lng" %>
        <button type="button" id="use_geo" style="padding:.4rem .6rem;">Usar minha localiza√ß√£o</button>
        <small id="geo_status" style="color:#666;"></small>
      </div>
      <div>
        <%= f.submit "PINSAR", style: "padding:.5rem .9rem;" %>
      </div>
    <% end %>

    <div id="joys_list" style="display:flex; flex-direction:column; gap:.5rem;">
      <%= render @joys %>
    </div>
  </div>
</div>

<script>
  (function() {
    const btn = document.getElementById('use_geo');
    const latField = document.getElementById('joy_lat');
    const lngField = document.getElementById('joy_lng');
    const status = document.getElementById('geo_status');
    if (!btn) return;
    btn.addEventListener('click', function() {
      status.textContent = 'Obtendo localiza√ß√£o...';
      if (!navigator.geolocation) {
        status.textContent = 'Geolocaliza√ß√£o n√£o suportada.';
        return;
      }
      navigator.geolocation.getCurrentPosition(function(pos) {
        latField.value = pos.coords.latitude.toFixed(6);
        lngField.value = pos.coords.longitude.toFixed(6);
        status.textContent = 'Localiza√ß√£o definida ‚úî';
      }, function(err) {
        status.textContent = 'N√£o foi poss√≠vel obter a localiza√ß√£o.';
      });
    });
  })();
</script> 